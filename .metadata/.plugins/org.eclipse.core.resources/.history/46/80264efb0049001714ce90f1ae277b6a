'''
Created on May 9, 2017

@author: iagmon
'''
import logging
from datetime import datetime
import os
from model.Utils import Consts as consts
from Loggers import XmlCreation
from controllers.CLIUtils.enums import TestStatus
class LoggerHandler(object):

    def __init__(self,dirPath):
        self.dirPath = dirPath
        self.currentLoggerName = []
        self.xmlFile = None

    def addLoggerFile(self, logger_name, log_file):
        log_setup = logging.getLogger(logger_name)
        formatter = logging.Formatter('%(levelname)s: %(asctime)s %(message)s', datefmt='%m/%d/%Y %I:%M:%S %p')
        fileHandler = logging.FileHandler(str(self.dirPath) + log_file, mode='a')
        fileHandler.setFormatter(formatter)
        log_setup.addHandler(fileHandler)
        log_setup.setLevel(logging.INFO)
        self.currentLoggerName.append(log_setup.name)

    def create_New_Logger(self,logger_name, folder_name= None):
        if(logger_name == consts.CLI_SESSION):
            log_file =  '\Logs\CMDSessions\cmdSession_' + str(datetime.now().strftime("%Y_%m_%d_%H_%M_%S")) +'.log'
            self.addLoggerFile(logger_name, log_file)
        if (folder_name!=None):
            self.create_new_dir_and_log(logger_name,folder_name)       
        if(logger_name!=consts.CLI_SESSION):  
            log_file =  '\Logs\LogsPerTest\_'+logger_name+"_" + str(datetime.now().strftime("%Y_%m_%d_%H_%M_%S")) +'.log'        
            self.addLoggerFile(logger_name, log_file)
        
    def create_new_dir_and_log(self,logger_name, folder_name):
        folderExists = True
        #### xml creation ###
        newpath = str(self.dirPath)+ str(r'\\Logs\\SpecificFolderOfTests\\' + folder_name)
        if not os.path.exists(newpath):
            os.makedirs(newpath)
            folderExists = False
            
        testName = logger_name+"_" + str(datetime.now().strftime("%Y_%m_%d_%H_%M_%S"))
        log_file =  '\\Logs\\SpecificFolderOfTests\\'+folder_name+"\\_"+testName +'.log'  
        #self.addLoggerFile(logger_name+folder_name, log_file)
        self.xmlFile = XmlCreation(folder_name,testName,self.dirPath+'\\Logs\\SpecificFolderOfTests\\'+folder_name+'\\',folderExists)
        self.xmlFile.buildXml()
        
    
    def reportStep(self,jsonFileName,testStatus):
        self.xmlFile.reportStep(jsonFileName,testStatus)
            
    def remove_Test_File_Logger(self):
        result = []
        for item in self.currentLoggerName:
            if item == consts.CLI_SESSION:
                result.append(item)
        self.currentLoggerName = result
             

    def print_And_Log_To_File(self,msg,printToTerminal, level="info"): 
        for logName in self.currentLoggerName :
            if(logName!=consts.CLI_SESSION):     
                log = logging.getLogger(logName)
                if level == 'info'    : log.info(msg) 
                if level == 'warning' : log.warning(msg)
                if level == 'error'   : log.error(msg)
            elif(printToTerminal):
                self.print_to_Logs_Files(msg)
    
    def print_to_Logs_Files(self,msg,is_cmd_only):
        log = logging.getLogger(consts.CLI_SESSION)
        log.info(msg)
        print msg          
        
    def get_Logger_By_Test_Name(self,nameOfLogger):
        log = logging.getLogger(nameOfLogger)
        return log