'''
Created on Apr 20, 2017

@author: iagmon
'''

from model.Utils.Assert import Assertion 
import model.Utils.JsonComparisonUtils as jsonComparer
from QuestionHandler import QuestionHandler
import os


class MyEngine(object):

    def __init__(self,testDefinition):
        '''
        Will recieve the test structure (the list of the json file and the step defintions). 
        Will read all the json files and save it as some structure.
        '''
        self.numberOfStep = 0
        self.testDefinietion = testDefinition
        self.assertion= Assertion()
        self.questionHandler = QuestionHandler()
        self.observers = []
        
    def process_request(self,httpRequest):
        '''
        This will received the request that 
        arrived from the eNodeB,
         will assert the request according to the json file and in case the assert was successful,
          will return the response from the json file        '''
        self.assertion.compareJsonReq(httpRequest,self.getExpectedJsonFileName())
        return self.process_response()
               
    
        
    
    def process_response(self):
        '''
        This will received the request that 
        arrived from the eNodeB,
         will assert the request according to the json file and in case the assert was successful,
          will return the response from the json file
        '''
        "start process response function"
        '''
        if(self.testDefinietion.defenitionsOfSteps[self.numberOfStep] == "nstep"):
            questionAnswerPart = jsonComparer.parseJsonToDic("C:/Users/iagmon/Desktop/jsonFolder/", self.getExpectedJsonFileName(),"questions")
            answers = self.questionHandler.ShowQuestionsAndGetAnswersFromClient(questionAnswerPart)
            print answers'''
                      
        jsonAfterParse = jsonComparer.parseJsonToDic("C:/Users/iagmon/Desktop/jsonFolder/", self.getExpectedJsonFileName(),"response")
        questAnswerPartOfJson = jsonComparer.parseJsonToDic("C:/Users/iagmon/Desktop/jsonFolder/", self.getExpectedJsonFileName(),"questions")
        if(self.testDefinietion.defenitionsOfSteps[self.numberOfStep] == "nstep"):
            self.update_observers(jsonAfterParse,questAnswerPartOfJson)
        
        self.numberOfStep+=1
        return jsonAfterParse
    
    def getExpectedJsonFileName(self):
        return self.testDefinietion.jsonNamesOfSteps[self.numberOfStep]
    
    def register(self, observer):
        print "registered observer : " + str(observer)
        if not observer in self.observers:
            self.observers.append(observer)
    
    def update_observers(self, jsonAfterParse,questAnswerPartOfJson):
        answers = []
        for observer in reversed(self.observers):
            yield answers.append(observer.getResponseFromEngine(jsonAfterParse,questAnswerPartOfJson))
    
    def process_checks(self):
        '''
        This will received the request that 
        arrived from the eNodeB,
         will assert the request according to the json file and in case the assert was successful,
          will return the response from the json file
        '''
        "start process response function"
        '''
        if(self.testDefinietion.defenitionsOfSteps[self.numberOfStep] == "nstep"):
            questionAnswerPart = jsonComparer.parseJsonToDic("C:/Users/iagmon/Desktop/jsonFolder/", self.getExpectedJsonFileName(),"questions")
            answers = self.questionHandler.ShowQuestionsAndGetAnswersFromClient(questionAnswerPart)
            print answers'''
                      
        jsonAfterParse = jsonComparer.parseJsonToDic("C:/Users/iagmon/Desktop/jsonFolder/", self.getExpectedJsonFileName(),"response")
        questAnswerPartOfJson = jsonComparer.parseJsonToDic("C:/Users/iagmon/Desktop/jsonFolder/", self.getExpectedJsonFileName(),"questions")
        if(self.testDefinietion.defenitionsOfSteps[self.numberOfStep] == "nstep"):
            x = self.update_observers(jsonAfterParse,questAnswerPartOfJson)
        
        self.numberOfStep+=1
        for node in x:
            print x
        #return jsonAfterParse
        
    def process_request_Checks(self,httpRequest):
        '''
        This will received the request that 
        arrived from the eNodeB,
         will assert the request according to the json file and in case the assert was successful,
          will return the response from the json file        '''
        self.assertion.compareJsonReq(httpRequest,self.getExpectedJsonFileName())
        return self.process_checks()
        
    
    